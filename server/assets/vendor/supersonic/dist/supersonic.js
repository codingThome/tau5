var n={},n=n||{};(function(){"use strict";n.SECS_70YRS=2208988800,n.TWO_32=4294967296,n.defaults={metadata:!1,unpackSingleArgs:!0},n.isCommonJS=!!(typeof module<"u"&&module.exports),n.isNode=n.isCommonJS&&typeof window>"u",n.isElectron=!!(typeof process<"u"&&process.versions&&process.versions.electron),n.isBufferEnv=n.isNode||n.isElectron,n.isArray=function(s){return s&&Object.prototype.toString.call(s)==="[object Array]"},n.isTypedArrayView=function(s){return s.buffer&&s.buffer instanceof ArrayBuffer},n.isBuffer=function(s){return n.isBufferEnv&&s instanceof Buffer},n.Long=typeof Long<"u"?Long:void 0,n.TextDecoder=typeof TextDecoder<"u"?new TextDecoder("utf-8"):typeof util<"u"&&typeof(util.TextDecoder!=="undefined")?new util.TextDecoder("utf-8"):void 0,n.TextEncoder=typeof TextEncoder<"u"?new TextEncoder("utf-8"):typeof util<"u"&&typeof(util.TextEncoder!=="undefined")?new util.TextEncoder("utf-8"):void 0,n.dataView=function(s,e,t){return s.buffer?new DataView(s.buffer,e,t):s instanceof ArrayBuffer?new DataView(s,e,t):new DataView(new Uint8Array(s),e,t)},n.byteArray=function(s){if(s instanceof Uint8Array)return s;var e=s.buffer?s.buffer:s;if(!(e instanceof ArrayBuffer)&&(typeof e.length>"u"||typeof e=="string"))throw new Error("Can't wrap a non-array-like object as Uint8Array. Object was: "+JSON.stringify(s,null,2));return new Uint8Array(e)},n.nativeBuffer=function(s){return n.isBufferEnv?n.isBuffer(s)?s:Buffer.from(s.buffer?s:new Uint8Array(s)):n.isTypedArrayView(s)?s:new Uint8Array(s)},n.copyByteArray=function(s,e,t){if(n.isTypedArrayView(s)&&n.isTypedArrayView(e))e.set(s,t);else for(var r=t===void 0?0:t,i=Math.min(e.length-t,s.length),o=0,a=r;o<i;o++,a++)e[a]=s[o];return e},n.readString=function(s,e){for(var t=[],r=e.idx;r<s.byteLength;r++){var i=s.getUint8(r);if(i!==0)t.push(i);else{r++;break}}r=r+3&-4,e.idx=r;var o=n.isBufferEnv?n.readString.withBuffer:n.TextDecoder?n.readString.withTextDecoder:n.readString.raw;return o(t)},n.readString.raw=function(s){for(var e="",t=1e4,r=0;r<s.length;r+=t)e+=String.fromCharCode.apply(null,s.slice(r,r+t));return e},n.readString.withTextDecoder=function(s){var e=new Int8Array(s);return n.TextDecoder.decode(e)},n.readString.withBuffer=function(s){return Buffer.from(s).toString("utf-8")},n.writeString=function(s){var e=n.isBufferEnv?n.writeString.withBuffer:n.TextEncoder?n.writeString.withTextEncoder:null,t=s+"\0",r;e&&(r=e(t));for(var i=e?r.length:t.length,o=i+3&-4,a=new Uint8Array(o),l=0;l<i-1;l++){var c=e?r[l]:t.charCodeAt(l);a[l]=c}return a},n.writeString.withTextEncoder=function(s){return n.TextEncoder.encode(s)},n.writeString.withBuffer=function(s){return Buffer.from(s)},n.readPrimitive=function(s,e,t,r){var i=s[e](r.idx,!1);return r.idx+=t,i},n.writePrimitive=function(s,e,t,r,i){i=i===void 0?0:i;var o;return e?o=new Uint8Array(e.buffer):(o=new Uint8Array(r),e=new DataView(o.buffer)),e[t](i,s,!1),o},n.readInt32=function(s,e){return n.readPrimitive(s,"getInt32",4,e)},n.writeInt32=function(s,e,t){return n.writePrimitive(s,e,"setInt32",4,t)},n.readInt64=function(s,e){var t=n.readPrimitive(s,"getInt32",4,e),r=n.readPrimitive(s,"getInt32",4,e);return n.Long?new n.Long(r,t):{high:t,low:r,unsigned:!1}},n.writeInt64=function(s,e,t){var r=new Uint8Array(8);return r.set(n.writePrimitive(s.high,e,"setInt32",4,t),0),r.set(n.writePrimitive(s.low,e,"setInt32",4,t+4),4),r},n.readFloat32=function(s,e){return n.readPrimitive(s,"getFloat32",4,e)},n.writeFloat32=function(s,e,t){return n.writePrimitive(s,e,"setFloat32",4,t)},n.readFloat64=function(s,e){return n.readPrimitive(s,"getFloat64",8,e)},n.writeFloat64=function(s,e,t){return n.writePrimitive(s,e,"setFloat64",8,t)},n.readChar32=function(s,e){var t=n.readPrimitive(s,"getUint32",4,e);return String.fromCharCode(t)},n.writeChar32=function(s,e,t){var r=s.charCodeAt(0);if(!(r===void 0||r<-1))return n.writePrimitive(r,e,"setUint32",4,t)},n.readBlob=function(s,e){var t=n.readInt32(s,e),r=t+3&-4,i=new Uint8Array(s.buffer,e.idx,t);return e.idx+=r,i},n.writeBlob=function(s){s=n.byteArray(s);var e=s.byteLength,t=e+3&-4,r=4,i=t+r,o=new Uint8Array(i),a=new DataView(o.buffer);return n.writeInt32(e,a),o.set(s,r),o},n.readMIDIBytes=function(s,e){var t=new Uint8Array(s.buffer,e.idx,4);return e.idx+=4,t},n.writeMIDIBytes=function(s){s=n.byteArray(s);var e=new Uint8Array(4);return e.set(s),e},n.readColor=function(s,e){var t=new Uint8Array(s.buffer,e.idx,4),r=t[3]/255;return e.idx+=4,{r:t[0],g:t[1],b:t[2],a:r}},n.writeColor=function(s){var e=Math.round(s.a*255),t=new Uint8Array([s.r,s.g,s.b,e]);return t},n.readTrue=function(){return!0},n.readFalse=function(){return!1},n.readNull=function(){return null},n.readImpulse=function(){return 1},n.readTimeTag=function(s,e){var t=n.readPrimitive(s,"getUint32",4,e),r=n.readPrimitive(s,"getUint32",4,e),i=t===0&&r===1?Date.now():n.ntpToJSTime(t,r);return{raw:[t,r],native:i}},n.writeTimeTag=function(s){var e=s.raw?s.raw:n.jsToNTPTime(s.native),t=new Uint8Array(8),r=new DataView(t.buffer);return n.writeInt32(e[0],r,0),n.writeInt32(e[1],r,4),t},n.timeTag=function(s,e){s=s||0,e=e||Date.now();var t=e/1e3,r=Math.floor(t),i=t-r,o=Math.floor(s),a=s-o,l=i+a;if(l>1){var c=Math.floor(l),u=l-c;o+=c,l=u}var f=r+o+n.SECS_70YRS,h=Math.round(n.TWO_32*l);return{raw:[f,h]}},n.ntpToJSTime=function(s,e){var t=s-n.SECS_70YRS,r=e/n.TWO_32,i=(t+r)*1e3;return i},n.jsToNTPTime=function(s){var e=s/1e3,t=Math.floor(e),r=e-t,i=t+n.SECS_70YRS,o=Math.round(n.TWO_32*r);return[i,o]},n.readArguments=function(s,e,t){var r=n.readString(s,t);if(r.indexOf(",")!==0)throw new Error("A malformed type tag string was found while reading the arguments of an OSC message. String was: "+r," at offset: "+t.idx);var i=r.substring(1).split(""),o=[];return n.readArgumentsIntoArray(o,i,r,s,e,t),o},n.readArgument=function(s,e,t,r,i){var o=n.argumentTypes[s];if(!o)throw new Error("'"+s+"' is not a valid OSC type tag. Type tag string was: "+e);var a=o.reader,l=n[a](t,i);return r.metadata&&(l={type:s,value:l}),l},n.readArgumentsIntoArray=function(s,e,t,r,i,o){for(var a=0;a<e.length;){var l=e[a],c;if(l==="["){var u=e.slice(a+1),f=u.indexOf("]");if(f<0)throw new Error("Invalid argument type tag: an open array type tag ('[') was found without a matching close array tag ('[]'). Type tag was: "+t);var h=u.slice(0,f);c=n.readArgumentsIntoArray([],h,t,r,i,o),a+=f+2}else c=n.readArgument(l,t,r,i,o),a++;s.push(c)}return s},n.writeArguments=function(s,e){var t=n.collectArguments(s,e);return n.joinParts(t)},n.joinParts=function(s){for(var e=new Uint8Array(s.byteLength),t=s.parts,r=0,i=0;i<t.length;i++){var o=t[i];n.copyByteArray(o,e,r),r+=o.length}return e},n.addDataPart=function(s,e){e.parts.push(s),e.byteLength+=s.length},n.writeArrayArguments=function(s,e){for(var t="[",r=0;r<s.length;r++){var i=s[r];t+=n.writeArgument(i,e)}return t+="]",t},n.writeArgument=function(s,e){if(n.isArray(s))return n.writeArrayArguments(s,e);var t=s.type,r=n.argumentTypes[t].writer;if(r){var i=n[r](s.value);n.addDataPart(i,e)}return s.type},n.collectArguments=function(s,e,t){n.isArray(s)||(s=typeof s>"u"?[]:[s]),t=t||{byteLength:0,parts:[]},e.metadata||(s=n.annotateArguments(s));for(var r=",",i=t.parts.length,o=0;o<s.length;o++){var a=s[o];r+=n.writeArgument(a,t)}var l=n.writeString(r);return t.byteLength+=l.byteLength,t.parts.splice(i,0,l),t},n.readMessage=function(s,e,t){e=e||n.defaults;var r=n.dataView(s,s.byteOffset,s.byteLength);t=t||{idx:0};var i=n.readString(r,t);return n.readMessageContents(i,r,e,t)},n.readMessageContents=function(s,e,t,r){if(s.indexOf("/")!==0)throw new Error("A malformed OSC address was found while reading an OSC message. String was: "+s);var i=n.readArguments(e,t,r);return{address:s,args:i.length===1&&t.unpackSingleArgs?i[0]:i}},n.collectMessageParts=function(s,e,t){return t=t||{byteLength:0,parts:[]},n.addDataPart(n.writeString(s.address),t),n.collectArguments(s.args,e,t)},n.writeMessage=function(s,e){if(e=e||n.defaults,!n.isValidMessage(s))throw new Error("An OSC message must contain a valid address. Message was: "+JSON.stringify(s,null,2));var t=n.collectMessageParts(s,e);return n.joinParts(t)},n.isValidMessage=function(s){return s.address&&s.address.indexOf("/")===0},n.readBundle=function(s,e,t){return n.readPacket(s,e,t)},n.collectBundlePackets=function(s,e,t){t=t||{byteLength:0,parts:[]},n.addDataPart(n.writeString("#bundle"),t),n.addDataPart(n.writeTimeTag(s.timeTag),t);for(var r=0;r<s.packets.length;r++){var i=s.packets[r],o=i.address?n.collectMessageParts:n.collectBundlePackets,a=o(i,e);t.byteLength+=a.byteLength,n.addDataPart(n.writeInt32(a.byteLength),t),t.parts=t.parts.concat(a.parts)}return t},n.writeBundle=function(s,e){if(!n.isValidBundle(s))throw new Error("An OSC bundle must contain 'timeTag' and 'packets' properties. Bundle was: "+JSON.stringify(s,null,2));e=e||n.defaults;var t=n.collectBundlePackets(s,e);return n.joinParts(t)},n.isValidBundle=function(s){return s.timeTag!==void 0&&s.packets!==void 0},n.readBundleContents=function(s,e,t,r){for(var i=n.readTimeTag(s,t),o=[];t.idx<r;){var a=n.readInt32(s,t),l=t.idx+a,c=n.readPacket(s,e,t,l);o.push(c)}return{timeTag:i,packets:o}},n.readPacket=function(s,e,t,r){var i=n.dataView(s,s.byteOffset,s.byteLength);r=r===void 0?i.byteLength:r,t=t||{idx:0};var o=n.readString(i,t),a=o[0];if(a==="#")return n.readBundleContents(i,e,t,r);if(a==="/")return n.readMessageContents(o,i,e,t);throw new Error("The header of an OSC packet didn't contain an OSC address or a #bundle string. Header was: "+o)},n.writePacket=function(s,e){if(n.isValidMessage(s))return n.writeMessage(s,e);if(n.isValidBundle(s))return n.writeBundle(s,e);throw new Error("The specified packet was not recognized as a valid OSC message or bundle. Packet was: "+JSON.stringify(s,null,2))},n.argumentTypes={i:{reader:"readInt32",writer:"writeInt32"},h:{reader:"readInt64",writer:"writeInt64"},f:{reader:"readFloat32",writer:"writeFloat32"},s:{reader:"readString",writer:"writeString"},S:{reader:"readString",writer:"writeString"},b:{reader:"readBlob",writer:"writeBlob"},t:{reader:"readTimeTag",writer:"writeTimeTag"},T:{reader:"readTrue"},F:{reader:"readFalse"},N:{reader:"readNull"},I:{reader:"readImpulse"},d:{reader:"readFloat64",writer:"writeFloat64"},c:{reader:"readChar32",writer:"writeChar32"},r:{reader:"readColor",writer:"writeColor"},m:{reader:"readMIDIBytes",writer:"writeMIDIBytes"}},n.inferTypeForArgument=function(s){var e=typeof s;switch(e){case"boolean":return s?"T":"F";case"string":return"s";case"number":return"f";case"undefined":return"N";case"object":if(s===null)return"N";if(s instanceof Uint8Array||s instanceof ArrayBuffer)return"b";if(typeof s.high=="number"&&typeof s.low=="number")return"h";break}throw new Error("Can't infer OSC argument type for value: "+JSON.stringify(s,null,2))},n.annotateArguments=function(s){for(var e=[],t=0;t<s.length;t++){var r=s[t],i;if(typeof r=="object"&&r.type&&r.value!==void 0)i=r;else if(n.isArray(r))i=n.annotateArguments(r);else{var o=n.inferTypeForArgument(r);i={type:o,value:r}}e.push(i)}return e}})();var b=function(){};b.prototype.on=function(){};b.prototype.emit=function(){};b.prototype.removeListener=function(){};(function(){"use strict";n.supportsSerial=!1,n.firePacketEvents=function(e,t,r,i){t.address?e.emit("message",t,r,i):n.fireBundleEvents(e,t,r,i)},n.fireBundleEvents=function(e,t,r,i){e.emit("bundle",t,r,i);for(var o=0;o<t.packets.length;o++){var a=t.packets[o];n.firePacketEvents(e,a,t.timeTag,i)}},n.fireClosedPortSendError=function(e,t){t=t||"Can't send packets on a closed osc.Port object. Please open (or reopen) this Port by calling open().",e.emit("error",t)},n.Port=function(e){this.options=e||{},this.on("data",this.decodeOSC.bind(this))};var s=n.Port.prototype=Object.create(b.prototype);s.constructor=n.Port,s.send=function(e){var t=Array.prototype.slice.call(arguments),r=this.encodeOSC(e),i=n.nativeBuffer(r);t[0]=i,this.sendRaw.apply(this,t)},s.encodeOSC=function(e){e=e.buffer?e.buffer:e;var t;try{t=n.writePacket(e,this.options)}catch(r){this.emit("error",r)}return t},s.decodeOSC=function(e,t){e=n.byteArray(e),this.emit("raw",e,t);try{var r=n.readPacket(e,this.options);this.emit("osc",r,t),n.firePacketEvents(this,r,void 0,t)}catch(i){this.emit("error",i)}},n.SLIPPort=function(e){var t=this,r=this.options=e||{};r.useSLIP=r.useSLIP===void 0?!0:r.useSLIP,this.decoder=new slip.Decoder({onMessage:this.decodeOSC.bind(this),onError:function(o){t.emit("error",o)}});var i=r.useSLIP?this.decodeSLIPData:this.decodeOSC;this.on("data",i.bind(this))},s=n.SLIPPort.prototype=Object.create(n.Port.prototype),s.constructor=n.SLIPPort,s.encodeOSC=function(e){e=e.buffer?e.buffer:e;var t;try{var r=n.writePacket(e,this.options);t=slip.encode(r)}catch(i){this.emit("error",i)}return t},s.decodeSLIPData=function(e,t){this.decoder.decode(e,t)},n.relay=function(e,t,r,i,o,a){r=r||"message",i=i||"send",o=o||function(){},a=a?[null].concat(a):[];var l=function(c){a[0]=c,c=o(c),t[i].apply(t,a)};return e.on(r,l),{eventName:r,listener:l}},n.relayPorts=function(e,t,r){var i=r.raw?"raw":"osc",o=r.raw?"sendRaw":"send";return n.relay(e,t,i,o,r.transform)},n.stopRelaying=function(e,t){e.removeListener(t.eventName,t.listener)},n.Relay=function(e,t,r){var i=this.options=r||{};i.raw=!1,this.port1=e,this.port2=t,this.listen()},s=n.Relay.prototype=Object.create(b.prototype),s.constructor=n.Relay,s.open=function(){this.port1.open(),this.port2.open()},s.listen=function(){this.port1Spec&&this.port2Spec&&this.close(),this.port1Spec=n.relayPorts(this.port1,this.port2,this.options),this.port2Spec=n.relayPorts(this.port2,this.port1,this.options);var e=this.close.bind(this);this.port1.on("close",e),this.port2.on("close",e)},s.close=function(){n.stopRelaying(this.port1,this.port1Spec),n.stopRelaying(this.port2,this.port2Spec),this.emit("close",this.port1,this.port2)}})();(function(){"use strict";n.WebSocket=typeof WebSocket<"u"?WebSocket:void 0,n.WebSocketPort=function(e){n.Port.call(this,e),this.on("open",this.listen.bind(this)),this.socket=e.socket,this.socket&&(this.socket.readyState===1?(n.WebSocketPort.setupSocketForBinary(this.socket),this.emit("open",this.socket)):this.open())};var s=n.WebSocketPort.prototype=Object.create(n.Port.prototype);s.constructor=n.WebSocketPort,s.open=function(){(!this.socket||this.socket.readyState>1)&&(this.socket=new n.WebSocket(this.options.url)),n.WebSocketPort.setupSocketForBinary(this.socket);var e=this;this.socket.onopen=function(){e.emit("open",e.socket)},this.socket.onerror=function(t){e.emit("error",t)}},s.listen=function(){var e=this;this.socket.onmessage=function(t){e.emit("data",t.data,t)},this.socket.onclose=function(t){e.emit("close",t)},e.emit("ready")},s.sendRaw=function(e){if(!this.socket||this.socket.readyState!==1){n.fireClosedPortSendError(this);return}this.socket.send(e)},s.close=function(e,t){this.socket.close(e,t)},n.WebSocketPort.setupSocketForBinary=function(e){e.binaryType=n.isNode?"nodebuffer":"arraybuffer"}})();var B=n,{readPacket:He,writePacket:Ge,readMessage:Ze,writeMessage:qe,readBundle:Ye,writeBundle:Qe}=n;var R=class{constructor(e=null){this.workerBaseURL=e,this.workers={oscOut:null,oscIn:null,debug:null},this.callbacks={onRawOSC:null,onParsedOSC:null,onDebugMessage:null,onError:null,onInitialized:null},this.initialized=!1,this.sharedBuffer=null,this.ringBufferBase=null,this.bufferConstants=null}async init(e,t,r){if(this.initialized){console.warn("[ScsynthOSC] Already initialized");return}this.sharedBuffer=e,this.ringBufferBase=t,this.bufferConstants=r;try{this.workers.oscOut=new Worker(this.workerBaseURL+"osc_out_prescheduler_worker.js",{type:"module"}),this.workers.oscIn=new Worker(this.workerBaseURL+"osc_in_worker.js",{type:"module"}),this.workers.debug=new Worker(this.workerBaseURL+"debug_worker.js",{type:"module"}),this.setupWorkerHandlers();let i=[this.initWorker(this.workers.oscOut,"OSC SCHEDULER+WRITER"),this.initWorker(this.workers.oscIn,"OSC IN"),this.initWorker(this.workers.debug,"DEBUG")];await Promise.all(i),this.workers.oscIn.postMessage({type:"start"}),this.workers.debug.postMessage({type:"start"}),this.initialized=!0,this.callbacks.onInitialized&&this.callbacks.onInitialized()}catch(i){throw console.error("[ScsynthOSC] Initialization failed:",i),this.callbacks.onError&&this.callbacks.onError(i),i}}initWorker(e,t){return new Promise((r,i)=>{let o=setTimeout(()=>{i(new Error(`${t} worker initialization timeout`))},5e3),a=l=>{l.data.type==="initialized"&&(clearTimeout(o),e.removeEventListener("message",a),r())};e.addEventListener("message",a),e.postMessage({type:"init",sharedBuffer:this.sharedBuffer,ringBufferBase:this.ringBufferBase,bufferConstants:this.bufferConstants})})}setupWorkerHandlers(){this.workers.oscIn.onmessage=e=>{let t=e.data;switch(t.type){case"messages":t.messages.forEach(r=>{if(r.oscData&&(this.callbacks.onRawOSC&&this.callbacks.onRawOSC({oscData:r.oscData,sequence:r.sequence}),this.callbacks.onParsedOSC))try{let i={metadata:!1,unpackSingleArgs:!1},o=B.readPacket(r.oscData,i);this.callbacks.onParsedOSC(o)}catch(i){console.error("[ScsynthOSC] Failed to decode OSC message:",i,r)}});break;case"error":console.error("[ScsynthOSC] OSC IN error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"oscIn");break}},this.workers.debug.onmessage=e=>{let t=e.data;switch(t.type){case"debug":this.callbacks.onDebugMessage&&t.messages.forEach(r=>{this.callbacks.onDebugMessage(r)});break;case"error":console.error("[ScsynthOSC] DEBUG error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"debug");break}},this.workers.oscOut.onmessage=e=>{let t=e.data;switch(t.type){case"error":console.error("[ScsynthOSC] OSC OUT error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"oscOut");break}}}send(e,t={}){if(!this.initialized){console.error("[ScsynthOSC] Not initialized");return}let{editorId:r=0,runTag:i="",audioTimeS:o=null,currentTimeS:a=null}=t;this.workers.oscOut.postMessage({type:"send",oscData:e,editorId:r,runTag:i,audioTimeS:o,currentTimeS:a})}sendImmediate(e){if(!this.initialized){console.error("[ScsynthOSC] Not initialized");return}this.workers.oscOut.postMessage({type:"sendImmediate",oscData:e})}cancelEditorTag(e,t){this.initialized&&this.workers.oscOut.postMessage({type:"cancelEditorTag",editorId:e,runTag:t})}cancelEditor(e){this.initialized&&this.workers.oscOut.postMessage({type:"cancelEditor",editorId:e})}cancelAll(){this.initialized&&this.workers.oscOut.postMessage({type:"cancelAll"})}clearDebug(){this.initialized&&this.workers.debug.postMessage({type:"clear"})}onRawOSC(e){this.callbacks.onRawOSC=e}onParsedOSC(e){this.callbacks.onParsedOSC=e}onDebugMessage(e){this.callbacks.onDebugMessage=e}onError(e){this.callbacks.onError=e}onInitialized(e){this.callbacks.onInitialized=e}terminate(){this.workers.oscOut&&(this.workers.oscOut.postMessage({type:"stop"}),this.workers.oscOut.terminate()),this.workers.oscIn&&(this.workers.oscIn.postMessage({type:"stop"}),this.workers.oscIn.terminate()),this.workers.debug&&(this.workers.debug.postMessage({type:"stop"}),this.workers.debug.terminate()),this.workers={oscOut:null,oscIn:null,debug:null},this.initialized=!1}};var ae={5120:"i8",5121:"u8",5122:"i16",5123:"u16",5124:"i32",5125:"u32",5126:"f32"};var z={u8:1,u8c:1,i8:1,u16:2,i16:2,u32:4,i32:4,i64:8,u64:8,f32:4,f64:8};var le={f32:Float32Array,f64:Float64Array},ce={i8:Int8Array,i16:Int16Array,i32:Int32Array},ue={u8:Uint8Array,u8c:Uint8ClampedArray,u16:Uint16Array,u32:Uint32Array},fe={i64:BigInt64Array,u64:BigUint64Array},he={...le,...ce,...ue},de=s=>{let e=ae[s];return e!==void 0?e:s};function $(s,...e){let t=fe[s];return new(t||he[de(s)])(...e)}var M=(s,e)=>(e--,s+e&~e);var W=s=>typeof s=="number";var k=(s,e=t=>t!==void 0?": "+t:"")=>class extends Error{origMessage;constructor(t){super(s(t)+e(t)),this.origMessage=t!==void 0?String(t):""}};var pe=k(()=>"Assertion failed"),U=(typeof process<"u"&&process.env!==void 0?process.env.UMBRELLA_ASSERTS:!import.meta.env||import.meta.env.MODE!=="production"||import.meta.env.UMBRELLA_ASSERTS||import.meta.env.VITE_UMBRELLA_ASSERTS)?(s,e)=>{if(typeof s=="function"&&!s()||!s)throw new pe(typeof e=="function"?e():e)}:()=>{};var me=k(()=>"illegal argument(s)"),V=s=>{throw new me(s)};var H=0,G=1,Z=2,q=3,Y=4,A=5,Q=6,D=1,F=2,j=7*4,x=0,N=1,g=2*4,P=class{buf;start;u8;u32;state;constructor(e={}){if(this.buf=e.buf?e.buf:new ArrayBuffer(e.size||4096),this.start=e.start!=null?M(Math.max(e.start,0),4):0,this.u8=new Uint8Array(this.buf),this.u32=new Uint32Array(this.buf),this.state=new Uint32Array(this.buf,this.start,j/4),!e.skipInitialization){let t=e.align||8;U(t>=8,`invalid alignment: ${t}, must be a pow2 and >= 8`);let r=this.initialTop(t),i=e.end!=null?Math.min(e.end,this.buf.byteLength):this.buf.byteLength;r>=i&&V(`insufficient address range (0x${this.start.toString(16)} - 0x${i.toString(16)})`),this.align=t,this.doCompact=e.compact!==!1,this.doSplit=e.split!==!1,this.minSplit=e.minSplit||16,this.end=i,this.top=r,this._free=0,this._used=0}}stats(){let e=r=>{let i=0,o=0;for(;r;)i++,o+=this.blockSize(r),r=this.blockNext(r);return{count:i,size:o}},t=e(this._free);return{free:t,used:e(this._used),top:this.top,available:this.end-this.top+t.size,total:this.buf.byteLength}}callocAs(e,t,r=0){let i=this.mallocAs(e,t);return i?.fill(r),i}mallocAs(e,t){let r=this.malloc(t*z[e]);return r?$(e,this.buf,r,t):void 0}calloc(e,t=0){let r=this.malloc(e);return r&&this.u8.fill(t,r,r+e),r}malloc(e){if(e<=0)return 0;let t=M(e+g,this.align),r=this.end,i=this.top,o=this._free,a=0;for(;o;){let l=this.blockSize(o),c=o+l>=i;if(c||l>=t)return this.mallocTop(o,a,l,t,c);a=o,o=this.blockNext(o)}return o=i,i=o+t,i<=r?(this.initBlock(o,t,this._used),this._used=o,this.top=i,v(o)):0}mallocTop(e,t,r,i,o){if(o&&e+i>this.end)return 0;if(t?this.unlinkBlock(t,e):this._free=this.blockNext(e),this.setBlockNext(e,this._used),this._used=e,o)this.top=e+this.setBlockSize(e,i);else if(this.doSplit){let a=r-i;a>=this.minSplit&&this.splitBlock(e,i,a)}return v(e)}realloc(e,t){if(t<=0)return 0;let r=L(e),i=0,o=this._used,a=0;for(;o;){if(o===r){[i,a]=this.reallocBlock(o,t);break}o=this.blockNext(o)}return i&&i!==r&&this.u8.copyWithin(v(i),v(r),a),v(i)}reallocBlock(e,t){let r=this.blockSize(e),i=e+r,o=i>=this.top,a=M(t+g,this.align);if(a<=r){if(this.doSplit){let l=r-a;l>=this.minSplit?this.splitBlock(e,a,l):o&&(this.top=e+a)}else o&&(this.top=e+a);return[e,i]}return o&&e+a<this.end?(this.top=e+this.setBlockSize(e,a),[e,i]):(this.free(e),[L(this.malloc(t)),i])}reallocArray(e,t){if(e.buffer!==this.buf)return;let r=this.realloc(e.byteOffset,t*e.BYTES_PER_ELEMENT);return r?new e.constructor(this.buf,r,t):void 0}free(e){let t;if(W(e))t=e;else{if(e.buffer!==this.buf)return!1;t=e.byteOffset}t=L(t);let r=this._used,i=0;for(;r;){if(r===t)return i?this.unlinkBlock(i,r):this._used=this.blockNext(r),this.insert(r),this.doCompact&&this.compact(),!0;i=r,r=this.blockNext(r)}return!1}freeAll(){this._free=0,this._used=0,this.top=this.initialTop()}release(){return delete this.u8,delete this.u32,delete this.state,delete this.buf,!0}get align(){return this.state[Y]}set align(e){this.state[Y]=e}get end(){return this.state[q]}set end(e){this.state[q]=e}get top(){return this.state[Z]}set top(e){this.state[Z]=e}get _free(){return this.state[H]}set _free(e){this.state[H]=e}get _used(){return this.state[G]}set _used(e){this.state[G]=e}get doCompact(){return!!(this.state[A]&D)}set doCompact(e){e?this.state[A]|=1<<D-1:this.state[A]&=~D}get doSplit(){return!!(this.state[A]&F)}set doSplit(e){e?this.state[A]|=1<<F-1:this.state[A]&=~F}get minSplit(){return this.state[Q]}set minSplit(e){U(e>g,`illegal min split threshold: ${e}, require at least ${g+1}`),this.state[Q]=e}blockSize(e){return this.u32[(e>>2)+x]}setBlockSize(e,t){return this.u32[(e>>2)+x]=t,t}blockNext(e){return this.u32[(e>>2)+N]}setBlockNext(e,t){this.u32[(e>>2)+N]=t}initBlock(e,t,r){let i=e>>>2;return this.u32[i+x]=t,this.u32[i+N]=r,e}unlinkBlock(e,t){this.setBlockNext(e,this.blockNext(t))}splitBlock(e,t,r){this.insert(this.initBlock(e+this.setBlockSize(e,t),r,0)),this.doCompact&&this.compact()}initialTop(e=this.align){return M(this.start+j+g,e)-g}compact(){let e=this._free,t=0,r=0,i,o=!1;for(;e;){for(i=e,r=this.blockNext(e);r&&i+this.blockSize(i)===r;)i=r,r=this.blockNext(r);if(i!==e){let a=i-e+this.blockSize(i);this.setBlockSize(e,a);let l=this.blockNext(i),c=this.blockNext(e);for(;c&&c!==l;){let u=this.blockNext(c);this.setBlockNext(c,0),c=u}this.setBlockNext(e,l),o=!0}e+this.blockSize(e)>=this.top&&(this.top=e,t?this.unlinkBlock(t,e):this._free=this.blockNext(e)),t=e,e=this.blockNext(e)}return o}insert(e){let t=this._free,r=0;for(;t&&!(e<=t);)r=t,t=this.blockNext(t);r?this.setBlockNext(r,e):this._free=e,this.setBlockNext(e,t)}},v=s=>s>0?s+g:0,L=s=>s>0?s-g:0;var Se=8,C=class{#r;#o;#a;#d;#t;#s;#e;#n;#c;constructor(e){let{audioContext:t,sharedBuffer:r,bufferPoolConfig:i,sampleBaseURL:o,audioPathMap:a={},maxBuffers:l=1024}=e;if(!t)throw new Error("BufferManager requires audioContext");if(!r||!(r instanceof SharedArrayBuffer))throw new Error("BufferManager requires sharedBuffer (SharedArrayBuffer)");if(!i||typeof i!="object")throw new Error("BufferManager requires bufferPoolConfig (object with start, size, align)");if(!Number.isFinite(i.start)||i.start<0)throw new Error("bufferPoolConfig.start must be a non-negative number");if(!Number.isFinite(i.size)||i.size<=0)throw new Error("bufferPoolConfig.size must be a positive number");if(a&&typeof a!="object")throw new Error("audioPathMap must be an object");if(!Number.isInteger(l)||l<=0)throw new Error("maxBuffers must be a positive integer");this.#a=t,this.#d=r,this.#r=o,this.#o=a,this.#t=new P({buf:r,start:i.start,size:i.size,align:Se}),this.#s=i.size,this.#e=new Map,this.#n=new Map,this.#c=new Map,this.GUARD_BEFORE=3,this.GUARD_AFTER=1,this.MAX_BUFFERS=l;let c=(i.size/(1024*1024)).toFixed(0),u=(i.start/(1024*1024)).toFixed(0)}#u(e){if(typeof e!="string"||e.length===0)throw new Error("Invalid audio path: must be a non-empty string");if(e.includes(".."))throw new Error(`Invalid audio path: path cannot contain '..' (got: ${e})`);if(e.startsWith("/")||/^[a-zA-Z]:/.test(e))throw new Error(`Invalid audio path: path must be relative (got: ${e})`);if(e.includes("%2e")||e.includes("%2E"))throw new Error(`Invalid audio path: path cannot contain URL-encoded characters (got: ${e})`);if(e.includes("\\"))throw new Error(`Invalid audio path: use forward slashes only (got: ${e})`);if(this.#o[e])return this.#o[e];if(!this.#r)throw new Error(`sampleBaseURL not configured. Please set it in SuperSonic constructor options.
Example: new SuperSonic({ sampleBaseURL: "./dist/samples/" })
Or use CDN: new SuperSonic({ sampleBaseURL: "https://unpkg.com/supersonic-scsynth-samples@latest/samples/" })
Or install: npm install supersonic-scsynth-samples`);return this.#r+e}#E(e){if(!Number.isInteger(e)||e<0||e>=this.MAX_BUFFERS)throw new Error(`Invalid buffer number ${e} (must be 0-${this.MAX_BUFFERS-1})`)}async#p(e,t,r){let i=null,o=null,a=!1,l=await this.#A(e),c=!1;try{await this.#m(e);let{ptr:u,sizeBytes:f,...h}=await r();i=u;let{uuid:S,allocationComplete:m}=this.#f(e,t);o=S,this.#i(e,i,f,S,m),a=!0;let d=this.#B(e,S,m);return l(),c=!0,{ptr:i,uuid:S,allocationComplete:d,...h}}catch(u){throw a&&o?this.#S(e,o,!1):i&&this.#t.free(i),u}finally{c||l()}}async prepareFromFile(e){let{bufnum:t,path:r,startFrame:i=0,numFrames:o=0,channels:a=null}=e;return this.#E(t),this.#p(t,6e4,async()=>{let l=this.#u(r),c=await fetch(l);if(!c.ok)throw new Error(`Failed to fetch ${l}: ${c.status} ${c.statusText}`);let u=await c.arrayBuffer(),f=await this.#a.decodeAudioData(u),h=Math.max(0,Math.floor(i||0)),S=f.length-h,m=o&&o>0?Math.min(Math.floor(o),S):S;if(m<=0)throw new Error(`No audio frames available for buffer ${t} from ${r}`);let d=this.#y(a,f.numberOfChannels),w=d.length,p=m*w+(this.GUARD_BEFORE+this.GUARD_AFTER)*w,E=this.#_(p),y=new Float32Array(p),T=this.GUARD_BEFORE*w;for(let O=0;O<m;O++)for(let I=0;I<w;I++){let ne=d[I],oe=f.getChannelData(ne);y[T+O*w+I]=oe[h+O]}this.#l(E,y);let _=y.length*4;return{ptr:E,sizeBytes:_,numFrames:m,numChannels:w,sampleRate:f.sampleRate}})}async prepareEmpty(e){let{bufnum:t,numFrames:r,numChannels:i=1,sampleRate:o=null}=e;if(this.#E(t),!Number.isFinite(r)||r<=0)throw new Error(`/b_alloc requires a positive number of frames (got ${r})`);if(!Number.isFinite(i)||i<=0)throw new Error(`/b_alloc requires a positive channel count (got ${i})`);let a=Math.floor(r),l=Math.floor(i);return this.#p(t,5e3,async()=>{let c=a*l+(this.GUARD_BEFORE+this.GUARD_AFTER)*l,u=this.#_(c),f=new Float32Array(c);this.#l(u,f);let h=f.length*4;return{ptr:u,sizeBytes:h,numFrames:a,numChannels:l,sampleRate:o||this.#a.sampleRate}})}#y(e,t){return!e||e.length===0?Array.from({length:t},(r,i)=>i):(e.forEach(r=>{if(!Number.isInteger(r)||r<0||r>=t)throw new Error(`Channel ${r} is out of range (file has ${t} channels)`)}),e)}#_(e){let t=e*4,r=this.#t.malloc(t);if(r===0){let i=this.#t.stats(),o=((i.available||0)/(1024*1024)).toFixed(2),a=((i.total||0)/(1024*1024)).toFixed(2),l=(t/(1024*1024)).toFixed(2);throw new Error(`Buffer pool allocation failed: requested ${l}MB, available ${o}MB of ${a}MB total`)}return r}#l(e,t){new Float32Array(this.#d,e,t.length).set(t)}#h(e,t,r){return new Promise((i,o)=>{let a=setTimeout(()=>{this.#n.delete(e),o(new Error(`Buffer ${t} allocation timeout (${r}ms)`))},r);this.#n.set(e,{resolve:i,reject:o,timeout:a})})}#f(e,t){let r=crypto.randomUUID(),i=this.#h(r,e,t);return{uuid:r,allocationComplete:i}}async#A(e){let t=this.#c.get(e)||Promise.resolve(),r,i=new Promise(o=>{r=o});return this.#c.set(e,t.then(()=>i)),await t,()=>{r&&(r(),r=null),this.#c.get(e)===i&&this.#c.delete(e)}}#i(e,t,r,i,o){let a=this.#e.get(e),l={ptr:t,size:r,pendingToken:i,pendingPromise:o,previousAllocation:a?{ptr:a.ptr,size:a.size}:null};return this.#e.set(e,l),l}async#m(e){let t=this.#e.get(e);if(t&&t.pendingToken&&t.pendingPromise)try{await t.pendingPromise}catch{}}#B(e,t,r){return!r||typeof r.then!="function"?(this.#S(e,t,!0),Promise.resolve()):r.then(i=>(this.#S(e,t,!0),i)).catch(i=>{throw this.#S(e,t,!1),i})}#S(e,t,r){let i=this.#e.get(e);if(!i||i.pendingToken!==t)return;let o=i.previousAllocation;if(r){i.pendingToken=null,i.pendingPromise=null,i.previousAllocation=null,o?.ptr&&this.#t.free(o.ptr);return}i.ptr&&this.#t.free(i.ptr),i.pendingPromise=null,o?.ptr?this.#e.set(e,{ptr:o.ptr,size:o.size,pendingToken:null,previousAllocation:null}):this.#e.delete(e)}handleBufferFreed(e){let t=e[0],r=e[1],i=this.#e.get(t);if(!i){typeof r=="number"&&r!==0&&this.#t.free(r);return}if(typeof r=="number"&&r===i.ptr){this.#t.free(i.ptr),this.#e.delete(t);return}if(typeof r=="number"&&i.previousAllocation&&i.previousAllocation.ptr===r){this.#t.free(r),i.previousAllocation=null;return}this.#t.free(i.ptr),this.#e.delete(t)}handleBufferAllocated(e){let t=e[0],r=e[1],i=this.#n.get(t);i&&(clearTimeout(i.timeout),i.resolve({bufnum:r}),this.#n.delete(t))}allocate(e){let t=e*4,r=this.#t.malloc(t);if(r===0){let i=this.#t.stats(),o=((i.available||0)/(1024*1024)).toFixed(2),a=((i.total||0)/(1024*1024)).toFixed(2),l=(t/(1024*1024)).toFixed(2);console.error(`[BufferManager] Allocation failed: requested ${l}MB, available ${o}MB of ${a}MB total`)}return r}free(e){return this.#t.free(e)}getView(e,t){return new Float32Array(this.#d,e,t)}getStats(){return this.#t.stats()}getDiagnostics(){let e=this.#t.stats(),t=0,r=0;for(let i of this.#e.values())i&&(t+=i.size||0,i.pendingToken&&r++);return{active:this.#e.size,pending:r,bytesActive:t,pool:{total:this.#s,available:e.available||0,freeBytes:e.free?.size||0,freeBlocks:e.free?.count||0,usedBytes:e.used?.size||0,usedBlocks:e.used?.count||0}}}destroy(){for(let[e,t]of this.#n.entries())clearTimeout(t.timeout),t.reject(new Error("BufferManager destroyed"));this.#n.clear();for(let[e,t]of this.#e.entries())t.ptr&&this.#t.free(t.ptr);this.#e.clear(),this.#c.clear()}};var K={totalPages:1280,ringBufferReserved:1048576,bufferPoolOffset:17825792,bufferPoolSize:66060288,get totalMemory(){return this.bufferPoolOffset+this.bufferPoolSize},get wasmHeapSize(){return this.bufferPoolOffset-this.ringBufferReserved}};var J={numBuffers:1024,maxNodes:1024,maxGraphDefs:1024,maxWireBufs:64,numAudioBusChannels:128,numInputBusChannels:0,numOutputBusChannels:2,numControlBusChannels:4096,bufLength:128,realTimeMemorySize:8192,numRGens:64,realTime:!1,memoryLocking:!1,loadGraphDefs:0,preferredSampleRate:0,verbosity:0};function Ee(s,e,t=0){for(let r=0;r<=t;r++)if(Atomics.compareExchange(s,e,0,1)===0)return!0;return!1}function ge(s,e){Atomics.store(s,e,0)}function X({atomicView:s,dataView:e,uint8View:t,bufferConstants:r,ringBufferBase:i,controlIndices:o,oscMessage:a,maxSpins:l=0}){let c=a.length,u=r.MESSAGE_HEADER_SIZE+c;if(u>r.IN_BUFFER_SIZE-r.MESSAGE_HEADER_SIZE||!Ee(s,o.IN_WRITE_LOCK,l))return!1;try{let f=Atomics.load(s,o.IN_HEAD),h=Atomics.load(s,o.IN_TAIL);if((r.IN_BUFFER_SIZE-1-f+h)%r.IN_BUFFER_SIZE<u)return!1;let m=Atomics.add(s,o.IN_SEQUENCE,1),d=r.IN_BUFFER_SIZE-f;if(u>d){let p=new Uint8Array(r.MESSAGE_HEADER_SIZE),E=new DataView(p.buffer);E.setUint32(0,r.MESSAGE_MAGIC,!0),E.setUint32(4,u,!0),E.setUint32(8,m,!0),E.setUint32(12,0,!0);let y=i+r.IN_BUFFER_START+f,T=i+r.IN_BUFFER_START;if(d>=r.MESSAGE_HEADER_SIZE){t.set(p,y);let _=d-r.MESSAGE_HEADER_SIZE;t.set(a.subarray(0,_),y+r.MESSAGE_HEADER_SIZE),t.set(a.subarray(_),T)}else{t.set(p.subarray(0,d),y),t.set(p.subarray(d),T);let _=r.MESSAGE_HEADER_SIZE-d;t.set(a,T+_)}}else{let p=i+r.IN_BUFFER_START+f;e.setUint32(p,r.MESSAGE_MAGIC,!0),e.setUint32(p+4,u,!0),e.setUint32(p+8,m,!0),e.setUint32(p+12,0,!0),t.set(a,p+r.MESSAGE_HEADER_SIZE)}Atomics.load(s,o.IN_HEAD);let w=(f+u)%r.IN_BUFFER_SIZE;return Atomics.store(s,o.IN_HEAD,w),!0}finally{ge(s,o.IN_WRITE_LOCK)}}var se=class s{static osc={encode:e=>B.writePacket(e),decode:(e,t={metadata:!1})=>B.readPacket(e,t)};#r;#o;#a;#d;#t;#s;#e;#n;#c;#u;#E;#p;#y;#_;#l;#h;#f;#A;#i;#m;#B;#S;#k;#T;#R=null;#P=!1;#N=100;constructor(e={}){if(this.#l=!1,this.#h=!1,this.#f={},this.#A=null,this.#t=null,this.#s=null,this.#e=null,this.#r=null,this.#o=null,this.#a=null,this.#n=null,this.loadedSynthDefs=new Set,this.onOSC=null,this.onMessage=null,this.onMessageSent=null,this.onDebugMessage=null,this.onInitialized=null,this.onError=null,this.onMetricsUpdate=null,!e.workerBaseURL||!e.wasmBaseURL)throw new Error(`SuperSonic requires workerBaseURL and wasmBaseURL options. Example:
new SuperSonic({
  workerBaseURL: "/supersonic/workers/",
  wasmBaseURL: "/supersonic/wasm/"
})`);let t=e.workerBaseURL,r=e.wasmBaseURL,i={...J,...e.scsynthOptions};this.#i={wasmUrl:e.wasmUrl||r+"scsynth-nrt.wasm",wasmBaseURL:r,workletUrl:e.workletUrl||t+"scsynth_audio_worklet.js",workerBaseURL:t,development:!1,audioContextOptions:{latencyHint:"interactive",sampleRate:48e3},memory:K,worldOptions:i},this.#p=e.sampleBaseURL||null,this.#y=e.synthdefBaseURL||null,this.#_=e.audioPathMap||{},this.bootStats={initStartTime:null,initDuration:null}}get initialized(){return this.#l}get initializing(){return this.#h}async init(e={}){if(this.#l){console.warn("[SuperSonic] Already initialized");return}if(this.#h){console.warn("[SuperSonic] Initialization already in progress");return}this.#i={...this.#i,...e,audioContextOptions:{...this.#i.audioContextOptions,...e.audioContextOptions||{}}},this.#h=!0,this.bootStats.initStartTime=performance.now();try{this.#G(),this.#Z(),this.#q(),this.#Y();let t=await this.#j();await this.#K(t),await this.#J(),this.#te(),this.#z(),this.#X()}catch(t){throw this.#h=!1,console.error("[SuperSonic] Initialization failed:",t),this.onError&&this.onError(t),t}}getMetrics(){return this.#L()}setMetricsInterval(e){this.#N=e,this.#z()}stopMetricsPolling(){this.#U()}async send(e,...t){this.#M("send OSC messages");let r=t.map(a=>{if(typeof a=="string")return{type:"s",value:a};if(typeof a=="number")return{type:Number.isInteger(a)?"i":"f",value:a};if(a instanceof Uint8Array||a instanceof ArrayBuffer)return{type:"b",value:a instanceof ArrayBuffer?new Uint8Array(a):a};throw new Error(`Unsupported argument type: ${typeof a}`)}),i={address:e,args:r},o=s.osc.encode(i);return this.sendOSC(o)}async sendOSC(e,t={}){this.#M("send OSC data");let r=this.#he(e),i=await this.#de(r);if(this.#C("mainMessagesSent"),this.#C("mainBytesSent",i.length),this.onMessageSent&&this.onMessageSent(i),!this.#ne(i)&&this.#oe(i)){this.#C("preschedulerBypassed");return}let o=this.#_e(i),a={...t};o&&(a.audioTimeS=o.audioTimeS,a.currentTimeS=o.currentTimeS),this.#a.send(i,a)}get audioContext(){return this.#r}get workletNode(){return this.#o}get osc(){return this.#a}async loadSynthDef(e){if(!this.#l)throw new Error("SuperSonic not initialized. Call init() first.");let t;if(this.#$(e))t=e;else{if(!this.#y)throw new Error("synthdefBaseURL not configured. Either provide a full path or set synthdefBaseURL in constructor options.");t=`${this.#y}${e}.scsyndef`}try{let r=await fetch(t);if(!r.ok)throw new Error(`Failed to load synthdef from ${t}: ${r.status} ${r.statusText}`);let i=await r.arrayBuffer(),o=new Uint8Array(i);await this.send("/d_recv",o);let a=this.#fe(t);a&&this.loadedSynthDefs.add(a)}catch(r){throw console.error("[SuperSonic] Failed to load synthdef:",r),r}}async loadSynthDefs(e){if(!this.#l)throw new Error("SuperSonic not initialized. Call init() first.");let t={};await Promise.all(e.map(async i=>{try{await this.loadSynthDef(i),t[i]={success:!0}}catch(o){console.error(`[SuperSonic] Failed to load ${i}:`,o),t[i]={success:!1,error:o.message}}}));let r=Object.values(t).filter(i=>i.success).length;return t}async loadSample(e,t,r=0,i=0){this.#M("load samples");let o;if(this.#$(t))o=t;else{if(!this.#p)throw new Error("sampleBaseURL not configured. Either provide a full path or set sampleBaseURL in constructor options.");o=`${this.#p}${t}`}let a=await this.#I().prepareFromFile({bufnum:e,path:o,startFrame:r,numFrames:i});return await this.send("/b_allocPtr",e,a.ptr,a.numFrames,a.numChannels,a.sampleRate,a.uuid),a.allocationComplete}async sync(e=Math.floor(Math.random()*2147483647)){if(!this.#l)throw new Error("SuperSonic not initialized. Call init() first.");let t=new Promise((r,i)=>{let o=setTimeout(()=>{this.#u&&this.#u.delete(e),i(new Error("Timeout waiting for /synced response"))},1e4),a=l=>{clearTimeout(o),this.#u.delete(e),r()};this.#u||(this.#u=new Map),this.#u.set(e,a)});await this.send("/sync",e),await t}getInfo(){return this.#M("get info"),{sampleRate:this.#r.sampleRate,numBuffers:this.#i.worldOptions.numBuffers,totalMemory:this.#i.memory.totalMemory,wasmHeapSize:this.#i.memory.wasmHeapSize,bufferPoolSize:this.#i.memory.bufferPoolSize,bootTimeMs:this.bootStats.initDuration,capabilities:{...this.#f},version:this.#A}}async destroy(){this.#W(),this.#U(),this.#a&&(this.#a.terminate(),this.#a=null),this.#o&&(this.#o.disconnect(),this.#o=null),this.#r&&(await this.#r.close(),this.#r=null),this.#n&&(this.#n.destroy(),this.#n=null),this.#t=null,this.#l=!1,this.loadedSynthDefs.clear()}#G(){this.#f={audioWorklet:typeof AudioWorklet<"u",sharedArrayBuffer:typeof SharedArrayBuffer<"u",crossOriginIsolated:window.crossOriginIsolated===!0,atomics:typeof Atomics<"u",webWorker:typeof Worker<"u"};let t=["audioWorklet","sharedArrayBuffer","crossOriginIsolated","atomics","webWorker"].filter(r=>!this.#f[r]);if(t.length>0){let r=new Error(`Missing required features: ${t.join(", ")}`);throw this.#f.crossOriginIsolated||(this.#f.sharedArrayBuffer?r.message+=`

SharedArrayBuffer is available but cross-origin isolation is not enabled. Please ensure COOP and COEP headers are set correctly:
  Cross-Origin-Opener-Policy: same-origin
  Cross-Origin-Embedder-Policy: require-corp`:r.message+=`

SharedArrayBuffer is not available. This may be due to:
1. Missing COOP/COEP headers
2. Browser doesn't support SharedArrayBuffer
3. Browser security settings`),r}return this.#f}#Z(){let e=this.#i.memory;this.#d=new WebAssembly.Memory({initial:e.totalPages,maximum:e.totalPages,shared:!0}),this.#t=this.#d.buffer}#q(){return this.#r=new AudioContext(this.#i.audioContextOptions),this.#r}#Y(){this.#n=new C({audioContext:this.#r,sharedBuffer:this.#t,bufferPoolConfig:{start:this.#i.memory.bufferPoolOffset,size:this.#i.memory.bufferPoolSize},sampleBaseURL:this.#p,audioPathMap:this.#_,maxBuffers:this.#i.worldOptions.numBuffers})}async#Q(){let e=this.#i.wasmBaseURL+"manifest.json";try{let t=await fetch(e);if(!t.ok)return;let r=await t.json();this.#i.wasmUrl=this.#i.wasmBaseURL+r.wasmFile}catch{}}async#j(){this.#i.development&&await this.#Q();let e=await fetch(this.#i.wasmUrl);if(!e.ok)throw new Error(`Failed to load WASM: ${e.status} ${e.statusText}`);return await e.arrayBuffer()}async#K(e){await this.#r.audioWorklet.addModule(this.#i.workletUrl),this.#o=new AudioWorkletNode(this.#r,"scsynth-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]}),this.#o.connect(this.#r.destination),this.#o.port.postMessage({type:"init",sharedBuffer:this.#t}),this.#o.port.postMessage({type:"loadWasm",wasmBytes:e,wasmMemory:this.#d,worldOptions:this.#i.worldOptions,sampleRate:this.#r.sampleRate}),await this.#ee()}async#J(){this.#a=new R(this.#i.workerBaseURL),this.#a.onRawOSC(e=>{this.onOSC&&this.onOSC(e)}),this.#a.onParsedOSC(e=>{if(e.address==="/buffer/freed")this.#n?.handleBufferFreed(e.args);else if(e.address==="/buffer/allocated")this.#n?.handleBufferAllocated(e.args);else if(e.address==="/synced"&&e.args.length>0){let t=e.args[0];this.#u&&this.#u.has(t)&&this.#u.get(t)(e)}this.onMessage&&this.onMessage(e)}),this.#a.onDebugMessage(e=>{this.onDebugMessage&&this.onDebugMessage(e)}),this.#a.onError((e,t)=>{console.error(`[SuperSonic] ${t} error:`,e),this.onError&&this.onError(new Error(`${t}: ${e}`))}),await this.#a.init(this.#t,this.#s,this.#e)}#X(){this.#l=!0,this.#h=!1,this.bootStats.initDuration=performance.now()-this.bootStats.initStartTime,this.onInitialized&&this.onInitialized({capabilities:this.#f,bootStats:this.bootStats})}#ee(){return new Promise((e,t)=>{let r=setTimeout(()=>{t(new Error("AudioWorklet initialization timeout"))},5e3),i=async o=>{if(o.data.type!=="debug"){if(o.data.type==="error"){console.error("[AudioWorklet] Error:",o.data.error),clearTimeout(r),this.#o.port.removeEventListener("message",i),t(new Error(o.data.error||"AudioWorklet error"));return}o.data.type==="initialized"&&(clearTimeout(r),this.#o.port.removeEventListener("message",i),o.data.success?(o.data.ringBufferBase!==void 0?this.#s=o.data.ringBufferBase:console.warn("[SuperSonic] Warning: ringBufferBase not provided by worklet"),o.data.bufferConstants!==void 0?(this.#e=o.data.bufferConstants,this.#se(),await this.#ae(),this.#ue()):console.warn("[SuperSonic] Warning: bufferConstants not provided by worklet"),e()):t(new Error(o.data.error||"AudioWorklet initialization failed")))}};this.#o.port.addEventListener("message",i),this.#o.port.start()})}#te(){this.#o.port.onmessage=e=>{let{data:t}=e;switch(t.type){case"error":console.error("[Worklet] Error:",t.error),t.diagnostics&&(console.error("[Worklet] Diagnostics:",t.diagnostics),console.table(t.diagnostics)),this.onError&&this.onError(new Error(t.error));break;case"process_debug":break;case"debug":break;case"version":this.#A=t.version;break}}}#re(){if(!this.#T)return null;let e=this.#T;return{workletProcessCount:e[0],workletMessagesProcessed:e[1],workletMessagesDropped:e[2],workletSchedulerDepth:e[3],workletSchedulerMax:e[4],workletSchedulerDropped:e[5],workletSequenceGaps:e[24],preschedulerPending:e[6],preschedulerPeak:e[7],preschedulerSent:e[8],preschedulerRetriesSucceeded:e[9],preschedulerRetriesFailed:e[10],preschedulerBundlesScheduled:e[11],preschedulerEventsCancelled:e[12],preschedulerTotalDispatches:e[13],preschedulerMessagesRetried:e[14],preschedulerRetryQueueSize:e[15],preschedulerRetryQueueMax:e[16],preschedulerBypassed:e[25],oscInMessagesReceived:e[17],oscInMessagesDropped:e[18],oscInBytesReceived:e[19],debugMessagesReceived:e[20],debugBytesReceived:e[21],mainMessagesSent:e[22],mainBytesSent:e[23]}}#ie(){if(!this.#m||!this.#e||!this.#s)return null;let e=this.#s+this.#e.CONTROL_START,t=this.#m,r=Atomics.load(t,(e+0)/4),i=Atomics.load(t,(e+4)/4),o=Atomics.load(t,(e+8)/4),a=Atomics.load(t,(e+12)/4),l=Atomics.load(t,(e+16)/4),c=Atomics.load(t,(e+20)/4),u=(r-i+this.#e.IN_BUFFER_SIZE)%this.#e.IN_BUFFER_SIZE,f=(o-a+this.#e.OUT_BUFFER_SIZE)%this.#e.OUT_BUFFER_SIZE,h=(l-c+this.#e.DEBUG_BUFFER_SIZE)%this.#e.DEBUG_BUFFER_SIZE;return{inBufferUsed:{bytes:u,percentage:u/this.#e.IN_BUFFER_SIZE*100},outBufferUsed:{bytes:f,percentage:f/this.#e.OUT_BUFFER_SIZE*100},debugBufferUsed:{bytes:h,percentage:h/this.#e.DEBUG_BUFFER_SIZE*100}}}#C(e,t=1){if(!this.#T)return;let r={mainMessagesSent:22,mainBytesSent:23,preschedulerBypassed:25};Atomics.add(this.#T,r[e],t)}#L(){let e=performance.now(),t=this.#re()||{},r=this.#ie();if(r&&Object.assign(t,r),t.driftOffsetMs=this.#ce(),t.audioContextState=this.#r?.state||"unknown",this.#n){let o=this.#n.getStats();t.bufferPoolUsedBytes=o.used.size,t.bufferPoolAvailableBytes=o.available,t.bufferPoolAllocations=o.used.count}t.loadedSynthDefs=this.loadedSynthDefs?.size||0;let i=performance.now()-e;return i>1&&console.warn(`[SuperSonic] Slow metrics gathering: ${i.toFixed(2)}ms`),t}#z(){this.#U();let e=this.#N;this.#R=setInterval(()=>{if(this.onMetricsUpdate){if(this.#P){console.warn(`[SuperSonic] Metrics gathering took >${e}ms, skipping this interval`);return}this.#P=!0;try{let t=this.#L();this.onMetricsUpdate(t)}catch(t){console.error("[SuperSonic] Metrics gathering failed:",t)}finally{this.#P=!1}}},e)}#U(){this.#R&&(clearInterval(this.#R),this.#R=null)}#M(e="perform this operation"){if(!this.#l)throw new Error(`SuperSonic not initialized. Call init() before attempting to ${e}.`)}#se(){if(!this.#t||!this.#s||!this.#e){console.warn("[SuperSonic] Cannot initialize direct write views - missing buffer info");return}this.#m=new Int32Array(this.#t),this.#B=new DataView(this.#t),this.#S=new Uint8Array(this.#t);let e=this.#s+this.#e.METRICS_START;this.#T=new Uint32Array(this.#t,e,this.#e.METRICS_SIZE/4);let t=this.#e.CONTROL_START;this.#k={IN_HEAD:(this.#s+t+0)/4,IN_TAIL:(this.#s+t+4)/4,IN_SEQUENCE:(this.#s+t+24)/4,IN_WRITE_LOCK:(this.#s+t+40)/4}}#ne(e){return e.length>=8&&e[0]===35}#oe(e){return!this.#m||!this.#k?!1:X({atomicView:this.#m,dataView:this.#B,uint8View:this.#S,bufferConstants:this.#e,ringBufferBase:this.#s,controlIndices:this.#k,oscMessage:e})}#$(e){return e.includes("/")||e.includes("://")}#Ae(){return this.#n?.getStats()}async#ae(){if(!this.#e||!this.#r)return;let e;for(;e=this.#r.getOutputTimestamp(),!(e.contextTime>0);)await new Promise(a=>setTimeout(a,50));let i=(performance.timeOrigin+e.performanceTime)/1e3+2208988800-e.contextTime,o=new Float64Array(this.#t,this.#s+this.#e.NTP_START_TIME_START,1);o[0]=i,this.#E=i}#le(){if(!this.#e||!this.#r||this.#E===void 0)return;let e=this.#r.getOutputTimestamp(),o=(performance.timeOrigin+e.performanceTime)/1e3+2208988800-this.#E-e.contextTime,a=Math.round(o*1e3),l=new Int32Array(this.#t,this.#s+this.#e.DRIFT_OFFSET_START,1);Atomics.store(l,0,a)}#ce(){if(!this.#e)return 0;let e=new Int32Array(this.#t,this.#s+this.#e.DRIFT_OFFSET_START,1);return Atomics.load(e,0)}#ue(){this.#W(),this.#c=setInterval(()=>{this.#le()},15e3)}#W(){this.#c&&(clearInterval(this.#c),this.#c=null)}#fe(e){return!e||typeof e!="string"?null:(e.split("/").filter(Boolean).pop()||e).replace(/\.scsyndef$/i,"")}#he(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new Error("oscData must be ArrayBuffer or Uint8Array")}async#de(e){let t={metadata:!0,unpackSingleArgs:!1};try{let r=s.osc.decode(e,t),{packet:i,changed:o}=await this.#V(r);return o?s.osc.encode(i):e}catch(r){throw console.error("[SuperSonic] Failed to prepare OSC packet:",r),r}}async#V(e){if(e&&e.address){let{message:t,changed:r}=await this.#pe(e);return{packet:t,changed:r}}if(this.#ye(e)){let t=await Promise.all(e.packets.map(o=>this.#V(o)));if(!t.some(o=>o.changed))return{packet:e,changed:!1};let i=t.map(o=>o.packet);return{packet:{timeTag:e.timeTag,packets:i},changed:!0}}return{packet:e,changed:!1}}async#pe(e){switch(e.address){case"/b_alloc":return{message:await this.#we(e),changed:!0};case"/b_allocRead":return{message:await this.#me(e),changed:!0};case"/b_allocReadChannel":return{message:await this.#Se(e),changed:!0};default:return{message:e,changed:!1}}}async#me(e){let t=this.#I(),r=this.#O(e.args,0,"/b_allocRead requires a buffer number"),i=this.#H(e.args,1,"/b_allocRead requires a file path"),o=this.#b(e.args,2,0),a=this.#b(e.args,3,0),l=await t.prepareFromFile({bufnum:r,path:i,startFrame:o,numFrames:a});return this.#x(l.allocationComplete,`/b_allocRead ${r}`),this.#D(r,l)}async#Se(e){let t=this.#I(),r=this.#O(e.args,0,"/b_allocReadChannel requires a buffer number"),i=this.#H(e.args,1,"/b_allocReadChannel requires a file path"),o=this.#b(e.args,2,0),a=this.#b(e.args,3,0),l=[];for(let u=4;u<(e.args?.length||0)&&this.#F(e.args[u]);u++)l.push(Math.floor(this.#g(e.args[u])));let c=await t.prepareFromFile({bufnum:r,path:i,startFrame:o,numFrames:a,channels:l.length>0?l:null});return this.#x(c.allocationComplete,`/b_allocReadChannel ${r}`),this.#D(r,c)}async#we(e){let t=this.#I(),r=this.#O(e.args,0,"/b_alloc requires a buffer number"),i=this.#O(e.args,1,"/b_alloc requires a frame count"),o=2,a=1,l=this.#r?.sampleRate||44100;this.#F(this.#w(e.args,o))&&(a=Math.max(1,this.#b(e.args,o,1)),o++),this.#w(e.args,o)?.type==="b"&&o++,this.#F(this.#w(e.args,o))&&(l=this.#g(this.#w(e.args,o)));let c=await t.prepareEmpty({bufnum:r,numFrames:i,numChannels:a,sampleRate:l});return this.#x(c.allocationComplete,`/b_alloc ${r}`),this.#D(r,c)}#D(e,t){return{address:"/b_allocPtr",args:[this.#v(e),this.#v(t.ptr),this.#v(t.numFrames),this.#v(t.numChannels),this.#Ee(t.sampleRate),this.#ge(t.uuid)]}}#v(e){return{type:"i",value:Math.floor(e)}}#Ee(e){return{type:"f",value:e}}#ge(e){return{type:"s",value:String(e)}}#w(e,t){if(Array.isArray(e))return e[t]}#g(e){if(e!=null)return typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,"value")?e.value:e}#O(e,t,r){let i=this.#g(this.#w(e,t));if(!Number.isFinite(i))throw new Error(r);return Math.floor(i)}#b(e,t,r=0){let i=this.#g(this.#w(e,t));return Number.isFinite(i)?Math.floor(i):r}#H(e,t,r){let i=this.#g(this.#w(e,t));if(typeof i!="string")throw new Error(r);return i}#F(e){if(!e)return!1;let t=this.#g(e);return Number.isFinite(t)}#x(e,t){!e||typeof e.catch!="function"||e.catch(r=>{console.error(`[SuperSonic] ${t} allocation failed:`,r)})}#I(){if(!this.#n)throw new Error("Buffer manager not ready. Call init() before issuing buffer commands.");return this.#n}#ye(e){return e&&e.timeTag!==void 0&&Array.isArray(e.packets)}#_e(e){if(e.length<16||String.fromCharCode.apply(null,e.slice(0,8))!=="#bundle\0")return null;let i=new Float64Array(this.#t,this.#s+this.#e.NTP_START_TIME_START,1)[0];if(i===0)return console.warn("[SuperSonic] NTP start time not yet initialized"),null;let o=new Int32Array(this.#t,this.#s+this.#e.DRIFT_OFFSET_START,1),l=Atomics.load(o,0)/1e3,c=new Int32Array(this.#t,this.#s+this.#e.GLOBAL_OFFSET_START,1),f=Atomics.load(c,0)/1e3,h=i+l+f,S=new DataView(e.buffer,e.byteOffset),m=S.getUint32(8,!1),d=S.getUint32(12,!1);if(m===0&&(d===0||d===1))return null;let p=m+d/4294967296-h,E=this.#r.currentTime;return{audioTimeS:p,currentTimeS:E}}};export{se as SuperSonic};
/*! osc.js 2.4.5, Copyright 2024 Colin Clark | github.com/colinbdclark/osc.js */
